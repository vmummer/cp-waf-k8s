#!/bin/bash

alias k=microk8s.kubectl
LOG_FILE="microk8s-setup.log"
TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
LOG_FILE="microk8s-setup-$TIMESTAMP.log"


echo "ğŸ”§ Starting MicroK8s environment setup..." | tee -a "$LOG_FILE"

# Enable DNS
echo "ï¿½ï¿½ Enabling DNS add-on (CoreDNS)..." | tee -a "$LOG_FILE"
microk8s enable dns >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
  echo "âœ… DNS enabled. Internal service discovery is now active." | tee -a "$LOG_FILE"
else
  echo "âŒ DNS enable failed. See log for details." | tee -a "$LOG_FILE"
fi

# Enable Ingress
echo "ğŸŒ Enabling Ingress controller (NGINX)..." | tee -a "$LOG_FILE"
microk8s enable ingress >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
  echo "âœ… Ingress enabled. You can now expose services via HTTP/HTTPS." | tee -a "$LOG_FILE"
else
  echo "âŒ Ingress enable failed. See log for details." | tee -a "$LOG_FILE"
fi

# Enable HostPath Storage
echo "ğŸ’¾ Enabling HostPath storage..." | tee -a "$LOG_FILE"
microk8s enable hostpath-storage >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
  echo "âœ… HostPath storage enabled. PVCs will use local disk paths." | tee -a "$LOG_FILE"
else
  echo "âŒ HostPath storage enable failed. See log for details." | tee -a "$LOG_FILE"
fi

# Apply Kubernetes manifests
log "ğŸ“„ Applying Kubernetes manifests..."

for manifest in namespace.yaml coredns.yaml juiceshop.yaml vampi.yaml webciser.yaml; do
  log "ğŸ“„ Applying $manifest..."
  microk8s kubectl apply -f "$manifest" >> "$LOG_FILE" 2>&1
  if [ $? -eq 0 ]; then
    log "âœ… $manifest applied successfully."
  else
    log "âŒ Failed to apply $manifest. See log for details."
  fi
done


echo "ğŸ‰ MicroK8s setup complete. Details logged to '$LOG_FILE'." | tee -a "$LOG_FILE"

